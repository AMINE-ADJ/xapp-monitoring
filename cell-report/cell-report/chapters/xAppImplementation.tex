\chapter{xApp Implementation}
\label{chap:xapp}

\section{Design Overview}
The custom xApp is designed to collect KPM data in real-time. It runs as a sidecar to FlexRIC and communicates over the E2 interface.



\begin{figure}[h]
    \centering
    \includegraphics[width=1\linewidth]{xapp-architecture.png}
    \caption{Architecture of the KPM Data Collector xApp.}
    \label{fig:xapp_arch}
\end{figure}


\section{Implementation Details}
\subsection{Initialization}
The xApp initializes the E2 agent and discovers connected nodes:
\begin{codeblock}[language=c]{xApp Init}
init_e2_agent_api(args.ip, args.port, args.plmn, "KPM_Collector");
e2_node_arr_t e2_nodes = e2_nodes_connected();
\end{codeblock}

\subsection{Data Subscription}
We subscribe to multiple Service Models (SM) to get a complete view of the RAN state. Subscriptions are set to a 100ms interval:
\begin{codeblock}[language=c]{Subscriptions}
// MAC Layer metrics (MCS, BLER, PRB usage)
report_mac_sm(node_id, 100, sm_cb_mac);

// RLC Layer metrics (PDU counts, Bytes)
report_rlc_sm(node_id, 100, sm_cb_rlc);

// PDCP & GTP Layer metrics (Throughput, Handover)
report_pdcp_sm(node_id, 100, sm_cb_pdcp);
report_gtp_sm(node_id, 100, sm_cb_gtp);

// KPM Service Model (Standardized measurements)
report_kpm_sm(node_id, 100, sm_cb_kpm, action_def);
\end{codeblock}

\subsection{Callback Processing}
Asynchronous callbacks handle incoming data. For example, the KPM callback extracts throughput:
\begin{codeblock}[language=c]{KPM Callback}
void sm_cb_kpm(sm_ag_if_rd_t const* rd) {
    kpm_ind_data_t const* ind = &rd->kpm_stats;
    // Extract DL/UL Volume
    if (rec->type == DRB_PDCP_SDU_VOLUME_DL) 
        record.dl_throughput = rec->value;
}
\end{codeblock}

\section{Hybrid Data Collection & Aggregation}
While the FlexRIC xApp provides high-fidelity access to MAC, RLC, and PDCP layers, certain physical layer metrics (specifically detailed per-TTI RSRP, SINR, and HARQ feedback in the current OAI version) were extracted directly from the gNB logs to enrich the dataset.

\subsection{gNB Log Parsing}
A parallel collection process captures the standard output of the \texttt{oai-gnb} pod. Using regular expressions, we parse ephemeral radio conditions that are logged by the OAI PHY layer but not yet exposed via the E2 Service Models. This allows us to recover:
\begin{itemize}
    \item \textbf{Signal Quality}: RSRP (Reference Signal Received Power) and accurate SINR estimates.
    \item \textbf{HARQ Statistics}: Detailed retransmission counts per slot.
    \item \textbf{Synchronization Status}: Real-time "in-sync" / "out-of-sync" flags from the UE context.
\end{itemize}

\subsection{Data Stream Merging}
The final dataset is constructed by merging the high-frequency xApp CSV output with the parsed gNB logs. A custom Python post-processing script aligns these two asynchronous streams using a "lookback" algorithm based on the \texttt{Frame.Slot} timing and timestamps. This ensures that every high-level KPI (e.g., Throughput) is inextricably linked to the physical radio conditions (e.g., SINR) experienced at that exact moment.

\section{Metrics Significance \& Interpretation}
The collector captures a comprehensive set of metrics providing visibility into Coverage, Quality, Reliability, and Load. Their interpretation is detailed below:

\subsection{Radio Conditions (Coverage \& Quality)}
\begin{itemize}
    \item \textbf{RSRP (Reference Signal Received Power)}: Indicates signal strength.
    \begin{itemize}
        \item \textit{Interpretation}: Values $>-80$ dBm represent excellent coverage. Values $<-100$ dBm typical of cell-edge. In our RF simulator, values like $-44$ dBm indicate effectively "wired" ideal conditions.
    \end{itemize}
    \item \textbf{SINR (Signal-to-Interference-plus-Noise Ratio)}: Indicates signal quality.
    \begin{itemize}
        \item \textit{Interpretation}: High SINR ($>20$ dB) allows high Modulation Coding Schemes (MCS). Low SINR ($<5$ dB) forces robust, low-throughput modulation (QPSK).
    \end{itemize}
    \item \textbf{RSRQ (Reference Signal Received Quality)}: Indicates quality relative to load/noise.
\end{itemize}

\subsection{Reliability \& Errors}
\begin{itemize}
    \item \textbf{BLER (Block Error Rate)}: The ratio of erroneous blocks to total blocks.
    \begin{itemize}
        \item \textit{Interpretation}: A key reliability metric. 5G typically targets $\approx 10\%$ BLER for initial transmissions, relying on HARQ for correction. Sustained high BLER ($>10\%$) after retransmissions indicates link failure.
    \end{itemize}
    \item \textbf{HARQ Retransmissions}: Count of re-sent packets.
    \begin{itemize}
        \item \textit{Interpretation}: High retransmissions with low residual BLER means the HARQ mechanism is working correctly.
    \end{itemize}
\end{itemize}

\subsection{Performance \& Load}
\begin{itemize}
    \item \textbf{Throughput (DL/UL)}: The actual user data rate.
    \begin{itemize}
        \item \textit{Interpretation}: The ultimate measure of user experience, directly correlated with MCS and PRB allocation.
    \end{itemize}
    \item \textbf{PRB Usage (Physical Resource Blocks)}: The percentage of time-frequency resources used.
    \begin{itemize}
        \item \textit{Interpretation}: Indicates cell load. High PRB usage with low throughput suggests spectral inefficiency (poor channel conditions).
    \end{itemize}
    \item \textbf{RLC Buffer Occupancy}: Data waiting in the queue.
    \begin{itemize}
        \item \textit{Interpretation}: High buffer occupancy implies the radio interface is the bottleneck (Congestion), often leading to increased latency.
    \end{itemize}
\end{itemize}

% \begin{figure}[H]
%     \centering
%     \fbox{\parbox{0.85\textwidth}{\centering\vspace{2.5cm}\textbf{[PLACEHOLDER: xApp Output]}\\\textit{Screenshot of terminal showing "KPM Indication received: ... "}\vspace{2.5cm}}}
%     \caption{Real-time logs from the xApp during execution.}
%     \label{fig:xapp_output}
% \end{figure}

\section{System Validation \& Execution Trace}
The following execution log demonstrates the complete valid operation of the system. It captures the initialization of the xApp, the successful subscription to O-RAN Service Models (MAC, RLC, PDCP, KPM), the real-time collection of metrics including RSRP coverage and throughput, and finally the integration with gNB logs.

\begin{lstlisting}[basicstyle=\ttfamily\scriptsize, breaklines=true, frame=single, caption={Real-time execution log validating xApp subscriptions and data merging.}, label={fig:validation_log}]
(base) amine@amine-ad:~/xapp-monitoring$ ./start-collection.sh
=================================================================
       5G Traffic Generation & xApp Data Collection             
=================================================================
Duration: 15s | Bandwidth: 1M

[INFO] Checking infrastructure...
UE: oai-nr-ue-5d6cb9c488-w4tnc
UPF: oai-upf-5c979b4878-x74gb (12.1.1.1)
RIC: oai-flexric-595cf8b79f-9dv94

[INFO] Setting up iperf3 Server on UPF...

[INFO] Deploying KPM xApp to FlexRIC...
[INFO] Compiling xApp...

[INFO] Starting Collection & Traffic (Duration: 15s)...
       xApp PID: 597270
       Traffic PID: 597823
       Waiting for test to complete...

[INFO] Retrieving Dataset...
[INFO] Capturing gNB logs...
tar: Removing leading `/' from member names
[SUCCESS] Data saved to: /home/rxxxf/etudes/cell/xapp-monitoring/xapp-dataset/kpm_metrics_20260112_155032.csv
          Rows collected: 1001

[INFO] Merging with gNB logs...
[INFO] Merging /home/rxxxf/etudes/cell/xapp-monitoring/xapp-dataset/kpm_metrics_20260112_155032.csv with metrics from /home/rxxxf/etudes/cell/projjet__final/xapp-monitoring/xapp-dataset/gnb_logs_20260112_155032.txt...
[INFO] Extracted 8 log data points.
[SUCCESS] Merged data saved to /home/rxxxf/etudes/cell/xapp-monitoring/xapp-dataset/dataset_full_20260112_155032.csv
          timestamp  frame  slot  ...  log_pcmax dl_thp_kbps  ul_thp_kbps
0  1768229421386595    529    11  ...          0         0.0          0.0
1  1768229421396548    529    11  ...          0         0.0          0.0
2  1768229421406635    529    11  ...          0         0.0          0.0
3  1768229421416647    529    11  ...          0         0.0          0.0
4  1768229421426615    529    11  ...          0         0.0          0.0

[5 rows x 15 columns]

Sample Data (Final):
timestamp,frame,slot,rnti,log_sync,log_rsrp,est_rsrq,est_sinr_dl,pusch_snr,pucch_snr,cqi,log_ph,log_pcmax,dl_thp_kbps,ul_thp_kbps,prb_tot_dl,prb_tot_ul,dl_prb,ul_prb,dl_bler,ul_bler,log_dlsch_err,log_ulsch_err,log_harq_dl,log_harq_ul,rlc_retx,dl_mcs1,ul_mcs1,dl_tbs,ul_tbs,rlc_sdu_delay_us,rlc_txbuf,bsr,dl_mcs2,ul_mcs2,dl_aggr_tbs,ul_aggr_tbs,dl_sched_rb,ul_sched_rb,phr,rlc_tx_pkts,rlc_tx_bytes,rlc_rx_pkts,rlc_rx_bytes,rlc_rxbuf,pdcp_tx_pkts,pdcp_tx_bytes,pdcp_rx_pkts,pdcp_rx_bytes,pdcp_vol_dl_kb,pdcp_vol_ul_kb
1768229421386595,529,11,20106,in-sync,-44,-34.0,25.0,51.0,53.0,0,0,0,0.0,0.0,0,0,1542449,29904624,0.0,0.0,0,0,1,1,0,9,8 ...
1768229421396548,529,11,20106,in-sync,-44,-34.0,25.0,51.0,53.0,0,0,0,0.0,0.0,0,0,1542449,29904624,0.0,0.0,0,0,1,1,0,9,8 ... 
1768229421406635,529,11,20106,in-sync,-44,-34.0,25.0,51.0,53.0,0,0,0,0.0,0.0,0,0,1542449,29904624,0.0,0.0,0,0,1,1,0,9,8 ... 
1768229421416647,529,11,20106,in-sync,-44,-34.0,25.0,51.0,53.0,0,0,0,0.0,0.0,0,0,1542449,29904624,0.0,0.0,0,0,1,1,0,9,8 ...
\end{lstlisting}